"use strict";var je=Object.create;var K=Object.defineProperty;var qe=Object.getOwnPropertyDescriptor;var Ge=Object.getOwnPropertyNames;var Be=Object.getPrototypeOf,He=Object.prototype.hasOwnProperty;var M=(e,t)=>()=>(e&&(t=e(e=0)),t);var U=(e,t)=>{for(var n in t)K(e,n,{get:t[n],enumerable:!0})},Te=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ge(t))!He.call(e,o)&&o!==n&&K(e,o,{get:()=>t[o],enumerable:!(i=qe(t,o))||i.enumerable});return e};var D=(e,t,n)=>(n=e!=null?je(Be(e)):{},Te(t||!e||!e.__esModule?K(n,"default",{value:e,enumerable:!0}):n,e)),ze=e=>Te(K({},"__esModule",{value:!0}),e);var Se={};U(Se,{getDefaultConfig:()=>ie,loadConfig:()=>_,watchConfigFile:()=>oe});function ie(){return{ignore:["node_modules",".git","dist","out",".ascii_history","*.log",".DS_Store","yarn.lock","package-lock.json"],architectureWatchPatterns:["src/**/*.{ts,tsx,js,jsx}","lib/**/*.{ts,tsx,js,jsx}","api/**/*.ts"],outputPaths:{fileTree:"docs/file_tree.md",architecture:"docs/architecture.md"},debounceMs:2e3,maxHistorySnapshots:50,autoWatchEnabled:!0,contextFiles:[],filePriority:[]}}async function _(e){let t=k.Uri.joinPath(e,".asciirc.json"),n=ie(),i;try{let c=await k.workspace.fs.readFile(t);i=Buffer.from(c).toString("utf-8")}catch{return n}let o;try{let c=Qe(i);o=JSON.parse(c)}catch(c){return k.window.showWarningMessage(`ASCII Agent: .asciirc.json is malformed \u2014 using defaults. (${String(c)})`),n}let s=Ye(n,o);return Ke(s)}function oe(e,t){let n=new k.RelativePattern(e,".asciirc.json"),i=k.workspace.createFileSystemWatcher(n),o=async()=>{let u=await _(e);t(u)},s=i.onDidCreate(o),c=i.onDidChange(o),l=i.onDidDelete(async()=>{t(ie())});return{dispose:()=>{i.dispose(),s.dispose(),c.dispose(),l.dispose()}}}function Ye(e,t){return{ignore:t.ignore!==void 0?t.ignore:e.ignore,architectureWatchPatterns:t.architectureWatchPatterns!==void 0?t.architectureWatchPatterns:e.architectureWatchPatterns,outputPaths:t.outputPaths!==void 0?{...e.outputPaths,...t.outputPaths}:e.outputPaths,debounceMs:t.debounceMs!==void 0?t.debounceMs:e.debounceMs,maxHistorySnapshots:t.maxHistorySnapshots!==void 0?t.maxHistorySnapshots:e.maxHistorySnapshots,autoWatchEnabled:t.autoWatchEnabled!==void 0?t.autoWatchEnabled:e.autoWatchEnabled,contextFiles:t.contextFiles!==void 0?t.contextFiles:e.contextFiles,filePriority:t.filePriority!==void 0?t.filePriority:e.filePriority,tags:t.tags!==void 0?t.tags:e.tags}}function Ke(e){return e.debounceMs<500&&(k.window.showWarningMessage("ASCII Agent: debounceMs must be \u2265 500. Resetting to 500."),e.debounceMs=500),e.maxHistorySnapshots<1&&(k.window.showWarningMessage("ASCII Agent: maxHistorySnapshots must be \u2265 1. Resetting to 1."),e.maxHistorySnapshots=1),e}function Qe(e){return e.replace(/\/\/[^\n]*/g,"")}var k,se=M(()=>{"use strict";k=D(require("vscode"))});function Pe(e){j=e}var j,a,W=M(()=>{"use strict";a={info(e){j?.appendLine(`[INFO]  ${e}`)},warn(e){j?.appendLine(`[WARN]  ${e}`)},error(e){j?.appendLine(`[ERROR] ${e}`)},raw(e){j?.appendLine(e)}}});var q={};U(q,{ensureDirectoryExists:()=>Je,matchesAnyPattern:()=>T,workspaceRelativePath:()=>de});function T(e,t){return t.some(n=>Xe(e,n))}function de(e,t){let n=t.fsPath.replace(/\\/g,"/").replace(/\/$/,""),i=e.fsPath.replace(/\\/g,"/");return i.startsWith(n+"/")?i.slice(n.length+1):i}async function Je(e){try{await xe.workspace.fs.createDirectory(e)}catch{}}function Xe(e,t){let n=e.replace(/\\/g,"/");return Ee(t).some(o=>Ve(n,o))}function Ee(e){let t=/\{([^{}]*)\}/.exec(e);if(!t)return[e];let n=t[1].split(","),i=[];for(let o of n){let s=e.slice(0,t.index)+o+e.slice(t.index+t[0].length);i.push(...Ee(s))}return i}function Ve(e,t){let n=t.replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*\*/g,"DOUBLESTAR").replace(/\*/g,"[^/]*").replace(/\u0001DOUBLESTAR\u0001/g,".*").replace(/\?/g,"[^/]");t.includes("/")?n="^"+n+"$":n="(^|.*/)("+n+")$";try{return new RegExp(n).test(e)}catch{return!1}}var xe,$=M(()=>{"use strict";xe=D(require("vscode"))});var G={};U(G,{generateFileTree:()=>tt});async function tt(e,t){let n=t.tags??et,i=0,o=!1;async function s(p,h,A){if(o)return[];let g;try{g=await L.workspace.fs.readDirectory(p)}catch{return[]}let f=g.filter(([m])=>{let P=h?`${h}/${m}`:m;return!T(P,t.ignore)&&!T(m,t.ignore)}).sort(([m,P],[O,z])=>{let R=P===L.FileType.Directory,Y=z===L.FileType.Directory;return R!==Y?R?-1:1:m.localeCompare(O)}),C=[];for(let m=0;m<f.length&&!o;m++){let[P,O]=f[m],z=m===f.length-1,R=h?`${h}/${P}`:P,Y=z?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ",Re=z?"    ":"\u2502   ";if(i++,i>Ze){let F=f.length-m;C.push(`${A}... (truncated: ${F} more entries not shown)`),o=!0;break}if(O===L.FileType.Directory){C.push(`${A}${Y}${P}/`);let F=await s(L.Uri.joinPath(p,P),R,A+Re);C.push(...F)}else{let F=nt(R,n),_e=F?`  ${F}`:"";C.push(`${A}${Y}${P}${_e}`)}}return C}let c=e.path.split("/").pop()??e.fsPath.split("/").pop()??"workspace",l=await s(e,"","");return`# File Tree

\`\`\`
${[c+"/",...l].join(`
`)}
\`\`\`
`}function nt(e,t){for(let[n,i]of Object.entries(t))if(T(e,[n]))return i}var L,Ze,et,B=M(()=>{"use strict";L=D(require("vscode"));$();Ze=5e3,et={"*.config.*":"[config]","*.json":"[config]","src/components/**":"[ui]","src/**":"[source]","lib/**":"[source]","api/**":"[backend]","docs/**":"[docs]","test/**":"[test]","scripts/**":"[script]"}});var le={};U(le,{cancelPendingTimers:()=>st,startWatching:()=>it,stopWatching:()=>ot});function it(e,t,n){let i=H.workspace.workspaceFolders;if(!i||i.length===0)return a.warn("startWatching: no workspace folder \u2014 aborting."),{dispose:()=>{}};let o=i[0].uri,s=H.workspace.createFileSystemWatcher(new H.RelativePattern(o,"**/*")),c=new Set([e.outputPaths.fileTree,e.outputPaths.architecture]);function l(v){let f=de(v,o);return c.has(f)||f.startsWith(".ascii_history/")||f===".ascii_history"||T(f,e.ignore)||T(f.split("/").pop()??"",e.ignore)?"ignore":T(f,e.architectureWatchPatterns)?"tree-and-arch":"tree-only"}function u(){I!==void 0&&clearTimeout(I),I=setTimeout(async()=>{I=void 0,a.info("Debounce expired \u2014 regenerating file tree.");try{await n.onTreeRegenNeeded()}catch(v){a.error(`Tree regen failed: ${String(v)}`)}},e.debounceMs)}function d(){x!==void 0&&clearTimeout(x),x=setTimeout(async()=>{x=void 0,a.info("Debounce expired \u2014 regenerating architecture diagram.");try{await n.onArchitectureRegenNeeded()}catch(v){a.error(`Architecture regen failed: ${String(v)}`)}},e.debounceMs)}function p(v){let f=l(v);f!=="ignore"&&(u(),f==="tree-and-arch"&&d())}let h=s.onDidCreate(p),A=s.onDidChange(p),g=s.onDidDelete(p);return a.info(`Watcher started. debounceMs=${e.debounceMs}`),{dispose:()=>{I!==void 0&&(clearTimeout(I),I=void 0),x!==void 0&&(clearTimeout(x),x=void 0),h.dispose(),A.dispose(),g.dispose(),s.dispose(),a.info("Watcher stopped.")}}}function ot(e){e.dispose()}function st(){I!==void 0&&(clearTimeout(I),I=void 0),x!==void 0&&(clearTimeout(x),x=void 0)}var H,I,x,ge=M(()=>{"use strict";H=D(require("vscode"));$();W()});var fe={};U(fe,{generateArchitectureDiagram:()=>ct});async function ct(e,t,n,i){let s=(await y.lm.selectChatModels({vendor:"copilot"}))[0],c=s?Math.floor(s.maxInputTokens*rt):8e3,l=await ut(e,t,c,s),u=await gt(e,t),d=await pt(e,t),p=t.path.split("/").filter(Boolean).pop()??t.fsPath.split(/[\\/]/).filter(Boolean).pop()??"workspace",h=at.replace("{workspace_folder_name}",p).replace("{previous_architecture}",u||"N/A").replace("{context_files_content}",d||"N/A").replace("{source_files_content}",l||"N/A");a.info(`Sending architecture prompt (~${h.length} chars) to LM.`);let A=[y.LanguageModelChatMessage.User(h)],g=await n.sendPrompt(A,i),v=mt(g);return a.info(`Architecture diagram received (${v.length} chars).`),{diagram:`# Architecture Diagram

\`\`\`
${v.trimEnd()}
\`\`\`
`,inputTokensEstimate:Math.ceil(h.length/4),outputTokensEstimate:Math.ceil(g.length/4)}}async function ut(e,t,n,i){let o=await dt(e,t),s=lt(o,e),c=[],l=0;for(let u of s){let d=y.Uri.joinPath(t,u),p;try{let g=await y.workspace.fs.readFile(d);p=Buffer.from(g).toString("utf-8")}catch{continue}let h=`// File: ${u}
${p}
`,A=i?await ht(i,h):Math.ceil(h.length/4);if(l+A>n){a.info(`Token budget reached. Skipping ${u} and remaining files.`);break}c.push(h),l+=A}return c.join(`
---
`)}async function dt(e,t){let n=[];async function i(o,s){let c;try{c=await y.workspace.fs.readDirectory(o)}catch{return}for(let[l,u]of c){let d=s?`${s}/${l}`:l;T(d,e.ignore)||T(l,e.ignore)||(u===y.FileType.Directory?await i(y.Uri.joinPath(o,l),d):u===y.FileType.File&&T(d,e.architectureWatchPatterns)&&n.push(d))}}return await i(t,""),n.sort()}function lt(e,t){if(t.filePriority.length>0)return[...e].sort((i,o)=>{let s=Me(i,t.filePriority),c=Me(o,t.filePriority);return s!==c?s-c:i.localeCompare(o)});let n=new Set(t.contextFiles);return[...e].sort((i,o)=>{let s=Ue(i,n),c=Ue(o,n);return s!==c?s-c:i.localeCompare(o)})}function Me(e,t){for(let n=0;n<t.length;n++)if(T(e,[t[n]]))return n;return t.length}function Ue(e,t){if(t.has(e))return 0;let n=e.split("/");return(n[0]==="src"||n[0]==="lib")&&n.length===2?1:n[0]==="src"||n[0]==="lib"?2:3}async function gt(e,t){try{let n=y.Uri.joinPath(t,e.outputPaths.architecture),i=await y.workspace.fs.readFile(n),o=Buffer.from(i).toString("utf-8");return ft(o)}catch{return""}}function ft(e){let t=e.match(/^(?:#[^\n]*\n+)?```[^\n]*\n([\s\S]*?)```\s*$/m);return t?t[1].trimEnd():e}async function pt(e,t){if(e.contextFiles.length===0)return"";let n=[];for(let i of e.contextFiles)try{let o=y.Uri.joinPath(t,i),s=await y.workspace.fs.readFile(o);n.push(`// Context file: ${i}
${Buffer.from(s).toString("utf-8")}`)}catch{a.warn(`Could not read context file: ${i}`)}return n.join(`
---
`)}function mt(e){let t=e.replace(/^```[a-z]*\n?/gm,"").replace(/^```\n?/gm,""),n=t.split(`
`),i=n.findIndex(s=>/^[+|]/.test(s.trim())||/^[-+]{3,}/.test(s.trim())),o=-1;for(let s=n.length-1;s>=0;s--)if(/^[+|]/.test(n[s].trim())||/^[-+]{3,}/.test(n[s].trim())){o=s;break}return i!==-1&&o!==-1&&i<=o&&(t=n.slice(i,o+1).join(`
`)),t.trim()+`
`}async function ht(e,t){try{return await e.countTokens(t)}catch{return Math.ceil(t.length/4)}}var y,rt,at,pe=M(()=>{"use strict";y=D(require("vscode"));$();W();rt=.8,at=`You are an ASCII architecture diagram generator for the software project "{workspace_folder_name}".

Your job is to produce a CONCEPTUAL data-flow diagram in pure ASCII art. The diagram must show:
- Major logical modules and their responsibilities
- Data flow between modules (arrows: ---> )
- State management cycles
- External API interactions
- Feedback loops

RULES:
1. Output ONLY the ASCII diagram. No markdown fences, no explanation text before or after.
2. Use box-drawing characters: +, -, |, > for arrows.
3. Keep column width under 100 characters.
4. Include a "Feedback loops:" text section at the bottom listing cyclic dependencies.
5. Do NOT include file paths or directory structure. This is a CONCEPTUAL diagram, not a physical one.
6. If a previous diagram is provided, preserve its general layout and only update sections that have changed based on the new source code. Do not gratuitously reorganize.

PREVIOUS DIAGRAM:
{previous_architecture}

PROJECT CONTEXT (if available):
{context_files_content}

SOURCE CODE CONTEXT:
{source_files_content}

Generate the updated architecture diagram now.`});var me={};U(me,{createLmClient:()=>wt});function wt(){let e,t=!1,n,i,o;async function s(){try{let g=await E.lm.selectChatModels({vendor:"copilot"});if(g.length>0)return e=g[0],a.info(`LM model selected: ${e.name} (vendor: ${e.vendor})`),e}catch(g){a.warn(`Model selection failed: ${String(g)}`)}e=void 0}let c=s();o=E.lm.onDidChangeChatModels(()=>{a.info("LM models changed \u2014 re-selecting."),c=s()});async function l(g,v){if(t)throw a.warn("LM quota cooldown active \u2014 skipping request."),new Error("ASCII Agent: LM quota cooldown active. Skipping request.");let f=e??await s();if(!f)throw new Error("ASCII Agent: No Copilot LM model available.");i&&(i.cancel(),i.dispose(),i=void 0);let C=new E.CancellationTokenSource;i=C;let m;v&&(m=v.onCancellationRequested(()=>C.cancel()));try{return await u(f,g,C.token)}finally{m?.dispose(),i===C&&(i=void 0),C.dispose()}}async function u(g,v,f){for(let C=0;C<2;C++)try{let m=await g.sendRequest(v,{},f),P="";for await(let O of m.text){if(f.isCancellationRequested)return P;P+=O}return P}catch(m){if(m instanceof E.LanguageModelError)return await d(m,C);if(C===0){a.warn(`LM request failed (attempt ${C+1}): ${String(m)}. Retrying in ${Q}ms...`),await $e(Q);continue}throw a.warn(`LM request failed after retry: ${String(m)}`),m}throw new Error("ASCII Agent: Unexpected end of executeRequest loop.")}async function d(g,v){let f=g.message.toLowerCase();throw f.includes("quota")||f.includes("rate limit")||g.code==="quota-exceeded"?(t=!0,a.warn(`LM quota exceeded. Cooldown for ${De/1e3}s.`),n=setTimeout(()=>{t=!1,a.info("LM quota cooldown expired.")},De),g):f.includes("consent")||f.includes("not authorized")||g.code==="no-permissions"?(a.warn("Copilot consent not given. Prompting user."),E.window.showInformationMessage("ASCII Agent: Please authorize GitHub Copilot to enable architecture diagram generation."),g):v===0?(a.warn(`LM error (attempt ${v+1}): ${String(g)}. Retrying in ${Q/1e3}s...`),await $e(Q),g):(a.error(`LM error after retry: ${String(g)}`),g)}function p(){i&&(i.cancel(),i.dispose(),i=void 0)}async function h(){return e===void 0&&await c,e!==void 0&&!t}function A(){p(),o?.dispose(),n!==void 0&&clearTimeout(n)}return{sendPrompt:l,cancelAll:p,isAvailable:h,dispose:A}}function $e(e){return new Promise(t=>setTimeout(t,e))}var E,De,Q,he=M(()=>{"use strict";E=D(require("vscode"));W();De=6e4,Q=3e3});var J={};U(J,{pruneSnapshots:()=>At,saveSnapshot:()=>vt});async function vt(e,t){let n=S.Uri.joinPath(e,Le);try{await S.workspace.fs.createDirectory(n)}catch{}let o=`architecture_${new Date().toISOString().replace(/:/g,"-")}.txt`,s=S.Uri.joinPath(n,o);await S.workspace.fs.writeFile(s,Buffer.from(t,"utf-8"))}async function At(e,t){let n=S.Uri.joinPath(e,Le),i;try{i=await S.workspace.fs.readDirectory(n)}catch{return}let o=i.filter(([u,d])=>d===S.FileType.File&&u.endsWith(".txt")).map(([u])=>u);if(o.length<=t)return;let s=[];for(let u of o)try{let d=await S.workspace.fs.stat(S.Uri.joinPath(n,u));s.push({name:u,mtime:d.mtime})}catch{s.push({name:u,mtime:0})}s.sort((u,d)=>u.mtime-d.mtime);let c=t-1,l=s.slice(0,s.length-c);for(let{name:u}of l)try{await S.workspace.fs.delete(S.Uri.joinPath(n,u))}catch{}}var S,Le,X=M(()=>{"use strict";S=D(require("vscode")),Le=".ascii_history"});var Et={};U(Et,{activate:()=>Ct,deactivate:()=>yt,resolveWorkspaceRoot:()=>V});module.exports=ze(Et);var r=D(require("vscode"));se();W();W();var be="asciiAgent.tokenUsage.lifetime",re="asciiAgent.tokenUsage.session";async function ae(e,t,n){let i=ce(e),o={inputTokensEstimate:i.inputTokensEstimate+t,outputTokensEstimate:i.outputTokensEstimate+n,requestCount:i.requestCount+1};await e.globalState.update(re,o);let s=ue(e),c={inputTokensEstimate:s.inputTokensEstimate+t,outputTokensEstimate:s.outputTokensEstimate+n,requestCount:s.requestCount+1};await e.globalState.update(be,c),a.info(`Token usage \u2014 request: ~${t} in / ~${n} out | session total: ~${o.inputTokensEstimate+o.outputTokensEstimate} tokens (${o.requestCount} requests) | lifetime: ~${c.inputTokensEstimate+c.outputTokensEstimate} tokens (${c.requestCount} requests)`)}async function ke(e){await e.globalState.update(re,{inputTokensEstimate:0,outputTokensEstimate:0,requestCount:0})}function ce(e){return e.globalState.get(re)??Ie()}function ue(e){return e.globalState.get(be)??Ie()}function Ie(){return{inputTokensEstimate:0,outputTokensEstimate:0,requestCount:0}}var w,N="disabled",b,Z,ve;function V(){return r.workspace.workspaceFolders?.[0]?.uri}function we(){r.window.showWarningMessage("ASCII Agent: No workspace folder is open."),a.warn("Command invoked with no open workspace folder.")}async function Ct(e){let t=r.window.createOutputChannel("ASCII Agent");if(e.subscriptions.push(t),Pe(t),ve=e,await ke(e),!r.workspace.workspaceFolders||r.workspace.workspaceFolders.length===0){a.warn("No workspace folder open \u2014 aborting activation.");return}r.workspace.workspaceFolders.length>1&&(a.warn("Multiple workspace folders detected. Only the first folder will be monitored."),r.window.showWarningMessage("ASCII Agent only monitors the first workspace folder."));let n=r.workspace.workspaceFolders[0].uri;w=await _(n),a.info(`Config loaded. debounceMs=${w.debounceMs}, autoWatch=${w.autoWatchEnabled}`);let i=oe(n,s=>{w=s,a.info("Config reloaded from .asciirc.json."),N==="active"&&(Ae(),ee(e,n))});e.subscriptions.push(i),b=r.window.createStatusBarItem(r.StatusBarAlignment.Left,100),b.command="asciiAgent.toggleAutoWatch",ne("disabled"),b.show(),e.subscriptions.push(b),e.subscriptions.push(r.commands.registerCommand("asciiAgent.initialize",()=>{let s=V();return s?Ne(s):we()}),r.commands.registerCommand("asciiAgent.generateNow",()=>{let s=V();return s?Tt(s):we()}),r.commands.registerCommand("asciiAgent.toggleAutoWatch",()=>{let s=V();return s?St(e,s):we()}),r.commands.registerCommand("asciiAgent.showTokenUsage",()=>Pt(e))),w.autoWatchEnabled&&ee(e,n);let o=r.window.setStatusBarMessage("ASCII Agent: active",3e3);e.subscriptions.push(o),await xt(e,n),a.info("Activated successfully.")}function yt(){Ae(),a.info("Deactivated.")}async function Ne(e){a.info("Running: asciiAgent.initialize");let{generateFileTree:t}=await Promise.resolve().then(()=>(B(),G)),{ensureDirectoryExists:n}=await Promise.resolve().then(()=>($(),q)),i=w.outputPaths.fileTree.split("/").slice(0,-1).join("/");await n(r.Uri.joinPath(e,i||"docs")),await kt(e),w=await _(e);let o=await bt(e,w);if(o.length>0){let c=o.map(u=>`\u2022 ${u}`).join(`
`);if(await r.window.showWarningMessage(`ASCII Agent: The following files already exist:

${c}

Overwrite them?`,{modal:!0},"Overwrite")!=="Overwrite"){a.info("Initialize cancelled by user \u2014 existing files would be overwritten.");return}}await Ce(e,t);let s=!1;await r.window.withProgress({location:r.ProgressLocation.Notification,title:"ASCII Agent",cancellable:!0},async(c,l)=>{s=await ye(e,c,l)}),s||r.window.showWarningMessage('ASCII Agent: File tree created. Architecture diagram skipped \u2014 Copilot not available yet. Run "ASCII Agent: Generate Now" once Copilot is ready.'),await It(e),r.window.showInformationMessage("ASCII Agent: Initialization complete."),a.info("Initialization complete.")}async function Tt(e){a.info("Running: asciiAgent.generateNow"),await r.window.withProgress({location:r.ProgressLocation.Notification,title:"ASCII Agent",cancellable:!0},async(t,n)=>{Promise.resolve().then(()=>(ge(),le)).then(({cancelPendingTimers:i})=>i()).catch(()=>{}),t.report({message:"Generating file tree..."}),Fe(!0);try{let{generateFileTree:i}=await Promise.resolve().then(()=>(B(),G)),{ensureDirectoryExists:o}=await Promise.resolve().then(()=>($(),q));if(n.isCancellationRequested)return;let s=w.outputPaths.fileTree.split("/").slice(0,-1).join("/");await o(r.Uri.joinPath(e,s||"docs"));let c=Date.now(),l=await i(e,w);if(await te(e,w.outputPaths.fileTree,l),a.info(`File tree generated in ${Date.now()-c}ms.`),n.isCancellationRequested)return;t.report({message:"Generating architecture diagram (AI)..."});let{generateArchitectureDiagram:u}=await Promise.resolve().then(()=>(pe(),fe)),{createLmClient:d}=await Promise.resolve().then(()=>(he(),me)),p=d();try{if(!await p.isAvailable()){r.window.showWarningMessage("ASCII Agent: Copilot model not available \u2014 only file tree was regenerated."),a.warn("LM unavailable \u2014 skipping architecture generation.");return}let h=Date.now(),A=await u(w,e,p,n);if(n.isCancellationRequested)return;let{saveSnapshot:g}=await Promise.resolve().then(()=>(X(),J));await g(e,A.diagram),await Oe(e),await te(e,w.outputPaths.architecture,A.diagram),await ae(ve,A.inputTokensEstimate,A.outputTokensEstimate),a.info(`Architecture diagram generated in ${Date.now()-h}ms.`),r.window.showInformationMessage("ASCII Agent: Diagrams updated.")}finally{p.dispose()}}finally{Fe(!1)}})}function St(e,t){N==="active"?(Ae(),r.window.showInformationMessage("ASCII Agent: Auto-watch is now OFF."),a.info("Auto-watch paused by user.")):(ee(e,t),r.window.showInformationMessage("ASCII Agent: Auto-watch is now ON."),a.info("Auto-watch started by user."))}function Pt(e){let t=ce(e),n=ue(e),i=d=>d.toLocaleString(),o=t.inputTokensEstimate+t.outputTokensEstimate,s=n.inputTokensEstimate+n.outputTokensEstimate,c=t.requestCount===1?"1 request":`${i(t.requestCount)} requests`,l=n.requestCount===1?"1 request":`${i(n.requestCount)} requests`,u=r.window.createQuickPick();u.title="ASCII Agent \u2014 Token Usage",u.placeholder="",u.ignoreFocusOut=!1,u.canSelectMany=!1,u.items=[{label:"Session (this window)",kind:r.QuickPickItemKind.Separator},{label:`  ~${i(o)} tokens   (${c})  \u2014 ~${i(t.inputTokensEstimate)} in / ~${i(t.outputTokensEstimate)} out`,alwaysShow:!0},{label:"Lifetime (all time)",kind:r.QuickPickItemKind.Separator},{label:`  ~${i(s)} tokens   (${l}) \u2014 ~${i(n.inputTokensEstimate)} in / ~${i(n.outputTokensEstimate)} out`,alwaysShow:!0},{label:"Note: Estimates only \u2014 LM streaming API does not provide exact counts.",kind:r.QuickPickItemKind.Separator}],u.onDidAccept(()=>u.hide()),u.onDidHide(()=>u.dispose()),u.show()}function ee(e,t){Promise.resolve().then(()=>(ge(),le)).then(({startWatching:n})=>{Z=n(w,e,{onTreeRegenNeeded:async()=>{let{generateFileTree:i}=await Promise.resolve().then(()=>(B(),G));await Ce(t,i)},onArchitectureRegenNeeded:async()=>{await ye(t)}}),e.subscriptions.push(Z),N="active",ne("active")})}function Ae(){Z?.dispose(),Z=void 0,N="paused",ne("paused")}function ne(e){if(b)switch(e){case"active":b.text="$(eye) ASCII Agent",b.tooltip="ASCII Agent: auto-watch active. Click to pause.";break;case"paused":b.text="$(eye-closed) ASCII Agent (paused)",b.tooltip="ASCII Agent: auto-watch paused. Click to resume.";break;case"disabled":b.text="$(eye) ASCII Agent",b.tooltip="ASCII Agent: inactive.";break}}function Fe(e){b&&(e?b.text="$(sync~spin) ASCII Agent: generating...":ne(N))}async function te(e,t,n){let{ensureDirectoryExists:i}=await Promise.resolve().then(()=>($(),q)),o=r.Uri.joinPath(e,t),s=t.split("/").slice(0,-1).join("/");s&&await i(r.Uri.joinPath(e,s)),await r.workspace.fs.writeFile(o,Buffer.from(n,"utf-8"))}async function Ce(e,t){try{let n=await t(e,w);await te(e,w.outputPaths.fileTree,n),a.info("File tree written successfully.")}catch(n){a.error(`Failed to generate file tree: ${String(n)}`)}}async function ye(e,t,n){try{let{generateArchitectureDiagram:i}=await Promise.resolve().then(()=>(pe(),fe)),{createLmClient:o}=await Promise.resolve().then(()=>(he(),me)),{saveSnapshot:s}=await Promise.resolve().then(()=>(X(),J)),c=o();try{if(!await c.isAvailable())return a.info("LM unavailable \u2014 skipping architecture generation."),!1;let l=Date.now();t?.report({message:"Generating architecture diagram (AI)... 0s elapsed"});let u=setInterval(()=>{let h=Math.round((Date.now()-l)/1e3);t?.report({message:`Generating architecture diagram (AI)... ${h}s elapsed`})},1e3),d;try{d=await i(w,e,c,n)}finally{clearInterval(u)}if(n?.isCancellationRequested||!d)return!1;await s(e,d.diagram),await Oe(e),await te(e,w.outputPaths.architecture,d.diagram),await ae(ve,d.inputTokensEstimate,d.outputTokensEstimate);let p=((Date.now()-l)/1e3).toFixed(1);return t?.report({message:`Architecture diagram complete (${p}s)`}),a.info(`Architecture diagram written successfully in ${p}s.`),!0}finally{c.dispose()}}catch(i){return a.error(`Failed to generate architecture diagram: ${String(i)}`),!1}}async function Oe(e){try{let{pruneSnapshots:t}=await Promise.resolve().then(()=>(X(),J));await t(e,w.maxHistorySnapshots)}catch(t){a.warn(`Snapshot pruning failed: ${String(t)}`)}}async function bt(e,t){let n=[t.outputPaths.fileTree,t.outputPaths.architecture],i=[];for(let o of n)try{await r.workspace.fs.stat(r.Uri.joinPath(e,o)),i.push(o)}catch{}return i}async function kt(e){let t=r.Uri.joinPath(e,".asciirc.json");try{await r.workspace.fs.stat(t)}catch{let{getDefaultConfig:n}=await Promise.resolve().then(()=>(se(),Se)),i=n(),o=JSON.stringify(i,null,2);await r.workspace.fs.writeFile(t,Buffer.from(o,"utf-8")),a.info("Created default .asciirc.json.")}}async function It(e){let t=r.Uri.joinPath(e,".gitignore"),n;try{let o=await r.workspace.fs.readFile(t);n=Buffer.from(o).toString("utf-8")}catch{return}if(n.includes(".ascii_history"))return;if(await r.window.showInformationMessage("ASCII Agent: Add .ascii_history/ to .gitignore?","Yes","No")==="Yes"){let o=n.trimEnd()+`

# ASCII Agent history snapshots
.ascii_history/
`;await r.workspace.fs.writeFile(t,Buffer.from(o,"utf-8")),a.info("Added .ascii_history/ to .gitignore.")}}var We="asciiAgent.welcomeShown";async function xt(e,t){if(e.globalState.get(We))return;await e.globalState.update(We,!0);let n="Initialize + Auto-Watch",i="Generate Once (No Watch)",o=await r.window.showInformationMessage("Welcome to ASCII Agent! Generate an ASCII file-tree and a Copilot-powered architecture diagram for this workspace. Choose how you'd like to start:",{modal:!0},n,i);if(o===n)a.info("Welcome prompt: user chose Initialize + Auto-Watch."),await Ne(t),N!=="active"&&ee(e,t);else if(o===i){a.info("Welcome prompt: user chose Generate Once.");let{generateFileTree:s}=await Promise.resolve().then(()=>(B(),G)),{ensureDirectoryExists:c}=await Promise.resolve().then(()=>($(),q)),l=w.outputPaths.fileTree.split("/").slice(0,-1).join("/");await c(r.Uri.joinPath(t,l||"docs")),await Ce(t,s);let u=!1;await r.window.withProgress({location:r.ProgressLocation.Notification,title:"ASCII Agent",cancellable:!0},async(d,p)=>{u=await ye(t,d,p)}),u?r.window.showInformationMessage('ASCII Agent: Diagrams generated. Run "ASCII Agent: Toggle Auto-Watch" any time to enable automatic updates.'):r.window.showWarningMessage('ASCII Agent: File tree created. Architecture diagram skipped \u2014 Copilot not available yet. Run "ASCII Agent: Generate Now" once Copilot is ready.')}else a.info("Welcome prompt: dismissed by user.")}0&&(module.exports={activate,deactivate,resolveWorkspaceRoot});
